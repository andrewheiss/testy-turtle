{
  "hash": "a34c0e81a14789bee5f58d88ff0d8964",
  "result": {
    "markdown": "---\ntitle: \"Working with tricky outcomes with lots of zeros\"\nformat:\n  html:\n    toc-depth: 4\n---\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(targets)\nlibrary(brms)\nlibrary(tidybayes)\nlibrary(scales)\nlibrary(patchwork)\nlibrary(ggtext)\nlibrary(ggh4x)\nlibrary(kableExtra)\nlibrary(broom.mixed)\nlibrary(marginaleffects)\n\n# Load stuff from targets\n# Plotting functions\ninvisible(list2env(tar_read(graphic_functions), .GlobalEnv))\n\ntar_load(c(m_oda_prelim_time_only_total, m_purpose_prelim_time_only_total))\n\ndf_country_aid <- tar_read(country_aid_final)\ndf_country_aid_laws <- filter(df_country_aid, laws)\n\n# Tell bayesplot to use the sunset palette for things like pp_check()\nbayesplot::color_scheme_set(clrs$Sunset[2:7])\n```\n:::\n\n\n# The problem with zeros\n\nAll of our outcome variables have a substantial and nontrivial number of zeros in them:\n\n\n::: {#tbl-zero-summary .cell layout-align=\"center\"}\n\n```{.r .cell-code}\nbind_rows(\n  `Total ODA (H1)` = count(df_country_aid_laws, is_zero = total_oda == 0),\n  `Proportion of contentious aid (H2)` = count(df_country_aid_laws, is_zero = prop_contentious == 0),\n  `Proportion of aid to domestic NGOs (H3)` = count(df_country_aid_laws, is_zero = prop_ngo_dom == 0),\n  `Proportion of aid to foreign NGOs (H3)` = count(df_country_aid_laws, is_zero = prop_ngo_foreign == 0),\n  .id = \"Outcome\"\n) %>% \n  group_by(Outcome) %>% \n  mutate(`Number of 0s` = glue::glue(\"{n[2]} / {sum(n)}\")) %>% \n  mutate(`Proportion of 0s` = label_percent(accuracy = 0.1)(n / sum(n))) %>% \n  ungroup() %>% \n  filter(is_zero) %>% select(-is_zero, -n) %>% \n  kbl(align = c(\"l\", \"c\", \"c\")) %>% \n  kable_styling(htmltable_class = \"table table-sm\",\n                full_width = FALSE)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\" table table-sm\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Outcome </th>\n   <th style=\"text-align:center;\"> Number of 0s </th>\n   <th style=\"text-align:center;\"> Proportion of 0s </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Total ODA (H1) </td>\n   <td style=\"text-align:center;\"> 198 / 3293 </td>\n   <td style=\"text-align:center;\"> 6.0% </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Proportion of contentious aid (H2) </td>\n   <td style=\"text-align:center;\"> 479 / 3293 </td>\n   <td style=\"text-align:center;\"> 14.5% </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Proportion of aid to domestic NGOs (H3) </td>\n   <td style=\"text-align:center;\"> 1452 / 3293 </td>\n   <td style=\"text-align:center;\"> 44.1% </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Proportion of aid to foreign NGOs (H3) </td>\n   <td style=\"text-align:center;\"> 1384 / 3293 </td>\n   <td style=\"text-align:center;\"> 42.0% </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nHere's what that looks like with foreign aid:\n\n\n::: {.cell .column-page-inset-right layout-align=\"center\"}\n\n```{.r .cell-code}\nplot_dist_unlogged <- df_country_aid_laws  %>%\n  mutate(is_zero = total_oda == 0) %>% \n  mutate(total_oda = ifelse(is_zero, -0.1, total_oda))  %>%  \n  ggplot(aes(x = total_oda)) +\n  geom_histogram(aes(fill = is_zero), binwidth = 2e9, \n                 linewidth = 0.25, boundary = 0, color = \"white\") +\n  geom_vline(xintercept = 0) + \n  scale_x_continuous(labels = label_dollar(scale_cut = cut_short_scale())) +\n  scale_y_continuous(labels = label_comma()) +\n  scale_fill_manual(values = c(clrs$Prism[2], clrs$Prism[8]), \n                    guide = guide_legend(reverse = TRUE)) +\n  labs(x = \"Total ODA\", y = \"Count\", fill = \"Is zero?\",\n       subtitle = \"Nice and exponentially shaped,\\nwith a bunch of zeros\") +\n  theme_donors() +\n  theme(legend.position = \"bottom\")\n## Warning: The `size` argument of `element_line()` is deprecated as of ggplot2 3.4.0.\n## ℹ Please use the `linewidth` argument instead.\n\nplot_dist_logged <- df_country_aid_laws %>%\n  mutate(is_zero = total_oda_log == 0) %>% \n  mutate(total_oda_log = ifelse(is_zero, -0.1, total_oda_log))  %>%  \n  ggplot(aes(x = total_oda_log)) +\n  geom_histogram(aes(fill = is_zero), binwidth = 1, \n                 linewidth = 0.25, boundary = 0, color = \"white\") +\n  geom_vline(xintercept = 0) +\n  scale_x_continuous(labels = label_math(e^.x)) +\n  scale_fill_manual(values = c(clrs$Prism[2], clrs$Prism[8]), \n                    guide = guide_legend(reverse = TRUE)) +\n  labs(x = \"Total ODA\", y = \"Count\", fill = \"Is zero?\",\n       subtitle = \"Nice and normally shaped, with a bunch of zeros;\\nit's hard to interpret intuitively though\") +\n  theme_donors() +\n  theme(legend.position = \"bottom\")\n\n(plot_dist_unlogged | plot_dist_logged) +\n  plot_layout(guides = \"collect\") +\n  plot_annotation(title = \"ODA, original vs. logged\",\n                  theme = theme(plot.title = element_text(family = \"Noto Sans\", face = \"bold\"),\n                                legend.position = \"bottom\"))\n```\n\n::: {.cell-output-display}\n![](model-tricky-outcomes_files/figure-html/plot-zero-outcomes-1.png){fig-align='center' width=90%}\n:::\n:::\n\n\nAnd with the proportion variables:\n\n\n# Hurdle vs. zero-inflated models\n\nThese zeros pose a whole host of tricky methodological issues. We could be like economists and just throw OLS at all these, or do what we've done in past versions of this paper and just use OLS on logged aid and fractional logit stuff for the proportions, but we can do better—we can model the zeros directly!\n\nIn the course of working on this paper, I've written a couple complete guides (for future me!) about two different approaches for doing this:\n\n- [Guide for hurdle models](https://www.andrewheiss.com/blog/2022/05/09/hurdle-lognormal-gaussian-brms/) (for total ODA)\n- [Guide for zero-inflated models](https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/) (for proportions)\n\nThere's actually a subtle difference between hurdle models and zero-inflated models, and [this Stack Exchange answer explains the distinction exceptionally well](https://stats.stackexchange.com/questions/81457/what-is-the-difference-between-zero-inflated-and-hurdle-models).\n\nPut simply, in hurdle models there's only one way to get a zero in the outcome; in zero-inflated models there are two ways to get a zero in the outcome. Both models use a two-step process:\n\n1. In the first stage for both types of models, we model if an outcome is either zero or not zero, or if the non-zero data generating process is on or off. It has a probability $\\pi$ of being off (or 0) and a probability $1 - \\pi$ of being on (or 1)\n\n2. In the second stage, the two models diverge a little\n\n   a. For hurdle models, there is only one way to get a zero, which is handled with the $\\pi$ part in the first stage. Predicted values of $y$ in this second stage cannot be zero, so the distribution of $y$ is truncated at $y > 0$. This is done with some fancy math that incorporates the probability of being not zero ($1 - \\pi$) and the regular distribution family (Poisson, lognormal, whatever):\n\n      $$\n      \\begin{aligned}\n      & \\textbf{Hurdle log-normal observation model} \\\\\n      y &\\sim \\operatorname{Hurdle\\,log-normal}(\\mu, \\sigma, \\pi) \\quad \\text{or alternatively,}\\\\\n      y &\\sim \\begin{cases}\n      0 & \\text{with probability } \\pi \\\\\n      \\operatorname{Log-normal}(\\mu, \\sigma) & \\text{with probability } 1 - \\pi\n      \\end{cases} \\\\[4pt]\n      \\operatorname{logit}(\\pi) &= \\gamma_0 + \\gamma_1 x_1 \\\\\n      \\log(\\mu) &= \\beta_0 + \\beta_1 x_1 \\\\\n      \\sigma &\\sim \\operatorname{Exponential}(1) \\\\[10pt]\n      & \\textbf{Likelihood of zero} \\\\\n      \\Pr(0 \\mid \\pi) &= \n      \\underbracket[0.25pt]{\\Pr(\\text{No $y$} \\mid \\pi)}_{\\substack{\\text{Probability}\\\\ \\text{of no $y$}}}\\ =\\ \\pi \\\\[10pt]\n      & \\textbf{Hurdle log-normal likelihood} \\\\\n      \\Pr(y \\mid \\pi, \\mu, \\sigma) &=\n      \\begin{dcases}\n      \\pi & \\text{if } y = 0 \\\\[4pt]\n      \\underbracket[0.25pt]{\\frac{(1 - \\pi) \\times \\operatorname{Log-normal}(y \\mid \\mu, \\sigma)}\n      {1 - \\operatorname{Log-normal}(0 \\mid \\mu, \\sigma)}}_{\\text{Will only predict $y > 0$}} & \\text{if } y > 0\n      \\end{dcases}\n      \\end{aligned}\n      $$\n\n   b. For zero-inflated models, there are two ways to get a zero. For example, in [section 12.2 in *Statistical Rethinking*](https://bookdown.org/content/4857/monsters-and-mixtures.html#example-zero-inflated-poisson.), @McElreath:2020 gives an example of monks who can either (1) drink and do no work, or (2) work and transcribe some number of manuscripts. There's a two-stage process for getting possible 0s here. A monk could transcribe 0 manuscripts because of the $\\pi$ on/off process in the first stage (e.g., they decide to drink and not even attempt to copy any manuscripts). Alternatively, the monk could be \"on\" in the first stage (e.g., they decide to not drink and to work instead), but then they don't end up transcribing anything (e.g., the final count is 0 because they were slow, lazy, had a difficult manuscript, or whatever).\n   \n      So we have to incorporate both avenues for getting a 0 into the likelihood for zero. Predicted values of $y$ in this stage *can* be zero, so unlike hurdle models, this isn't truncated or anything. We use some distribution family (Poisson, negative binomial, beta, whatever) at this stage and generate predictions where $y \\geq 0$.\n   \n      SUPER WEIRDLY THOUGH, despite its name, zero-inflated Beta regression [is actually kinda sorta a hurdle model and not a zero-inflated model](https://stats.stackexchange.com/a/81854/3025) because $\\operatorname{Beta}(0 \\mid \\mu, \\phi)$ isn't normally allowed since the Beta distribution typically only covers $0 < y < 1$ or (0, 1) rather than [0, 1]. That is, according to this definition of hurdling vs. zero-inflating, in zero-inflated models zero is still a possible outcome after moving past the first zero/not zero stage, but the Beta distribution typically doesn't allow for zeros. ::huge-shrug::\n   \n      $$\n      \\begin{aligned}\n      & \\textbf{Zero-inflated Beta observation model} \\\\\n      y &\\sim \\operatorname{Zero-inflated\\, Beta}(\\pi, \\mu, \\phi) \\quad \\text{or alternatively,}\\\\\n      y &\\sim \\begin{cases}\n      0 & \\text{with probability } \\pi + [(1 - \\pi) \\times \\operatorname{Beta}(0 \\mid \\mu, \\phi)] \\\\\n      \\operatorname{Beta}(\\mu, \\phi) & \\text{with probability } (1 - \\pi) \\times \\operatorname{Beta}(y \\mid \\mu, \\phi)\n      \\end{cases} \\\\[4pt]\n      \\operatorname{logit}(\\pi) &= \\gamma_0 + \\gamma_1 x_1 \\\\\n      \\operatorname{logit}(\\mu) &= \\beta_0 + \\beta_1 x_1 \\\\\n      \\phi &\\sim \\operatorname{Exponential}(1) \\\\[10pt]\n      & \\textbf{Likelihood of zero} \\\\\n      \\Pr(0 \\mid \\pi, \\mu, \\phi) &= \n      \\underbracket[0.25pt]{\\Pr(\\text{No $y$} \\mid \\pi)}_{\\substack{\\text{Probability of} \\\\ \\text{no $y$ at all}}} \n      \\ \\overbracket[0.25pt]{+}^{\\text{or}}\\ \n      \\underbracket[0.25pt]{\\left[\\Pr(\\text{Yes $y$} \\mid \\pi) \\times \\Pr(0 \\mid \\mu, \\phi)\\right]}_{\\substack{\\text{Probability of yes $y$,} \\\\ \\text{but it happens to be 0}}} \\\\\n      &= \\pi + [(1 - \\pi) \\times \\operatorname{Beta}(0 \\mid \\mu, \\phi)] \\\\[10pt]\n      & \\textbf{Zero-inflated Beta likelihood} \\\\\n      \\Pr(y \\mid \\pi, \\mu, \\phi) &=\n      \\begin{cases}\n      \\pi + [(1 - \\pi) \\times \\operatorname{Beta}(0 \\mid \\mu, \\phi)] & \\text{if } y = 0 \\\\[4pt]\n      \\underbracket[0.25pt]{(1 - \\pi) \\times \\operatorname{Beta}(y \\mid \\mu, \\phi)}_{\\text{Will predict $y \\geq 0$}} & \\text{if } y > 0\n      \\end{cases}\n      \\end{aligned}\n      $$\n\nWith all that… whatever. This difference doesn't super matter for us here. We'll use both of these kinds of families to model our zero-heavy outcomes.\n\n::: {.callout-tip}\n### More complete documentation\n\nFiguring out all this model and likelihood stuff for hurdle and zero-inflated regression has been really tricky and nuanced and I'm still not 100% sure this is 100% accurate. But thanks to some fantastic help from people on Twitter and Mastodon, I got this far! Here are some of the resources I used for all this:\n\n- [Aki Vehtari's Mastodon thread](https://bayes.club/@avehtari/109382966876733736) on the differences between likelihoods and distributions, and models. He proposes calling the whole complex formal hierarchical model a \"statistical model\" and calling the part that invovles observations an \"observation model\". He also distinguishes between (1) tilde notation ($y \\sim \\mathcal{N}(\\mu, \\sigma)$), which is read as \"y is distributed as normal(mu sigma),\" and which refers to the observation model, and (2) likelihood notation ($\\Pr(y \\mid \\theta)$), which can either be a distribution or a likelihood, resulting in all sorts of confusion.\n\n- The [brms vignette on zero-inflated and hurdle models](https://cran.r-project.org/web/packages/brms/vignettes/brms_families.html#zero-inflated-and-hurdle-models) defines the likelihood of both kinds of models in general mathy terms, where $z$ is the zero-inflation probability and $f(\\cdot)$ is the family for the second stage:\n\n  - Zero-inflated density:\n\n    $$\n    f_z(y) = \n    \\begin{cases}\n    z + (1 - z) f(0) & \\text{if } y = 0 \\\\\n    (1 - z) f(y) & \\text{if } y > 0\n    \\end{cases}\n    $$\n  \n  - Hurdle density:\n\n    $$\n    f_z(y) = \\begin{cases}\n    z & \\text{if } y = 0 \\\\\n    (1 - z) f(y) / (1 - f(0)) & \\text{if } y > 0\n    \\end{cases}\n    $$\n\n- [The Stan documentation for zero inflation](https://mc-stan.org/docs/stan-users-guide/zero-inflated.html) shows the same thing, with slightly different notation. It also shows the actual Stan code necessary for these kinds of models.\n\n- Sections 12.4.1 and 12.4.2 in @Frees:2009 ([copy here](https://finance.nankai.edu.cn/_upload/article/files/c6/44/73f40f574e069868d74d52345ece/69e1f4b9-4aa4-48d2-8c63-3e205e73c749.pdf)) provide a similar overview and slightly different notation for both kinds of models.\n\n:::\n\n\n\nTODO: Plot of outcomes over time like in my blog post, or just a few in facets\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndf_country_aid_laws %>% \n  mutate(prop_contentious = ifelse(prop_contentious == 0, -0.05, prop_contentious)) %>% \n  ggplot(aes(x = year, y = prop_contentious, group = country)) +\n  geom_line(size = 0.2, alpha = 0.5) +\n  geom_hline(yintercept = 0.001) +\n  scale_y_continuous(labels = c(\"Exactly 0%\", \">0%\", \"25%\", \"50%\", \"75%\", \"100%\"), \n                     breaks = c(-0.05, 0.001, 0.25, 0.5, 0.75, 1)) +\n  labs(x = NULL, y = \"Proportion of contentious aid\", color = NULL) +\n  theme_donors()\n## Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.\n## ℹ Please use `linewidth` instead.\n```\n\n::: {.cell-output-display}\n![](model-tricky-outcomes_files/figure-html/plot-all-prop-contentious-1.png){fig-align='center' width=100%}\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndf_country_aid_laws %>% \n  mutate(prop_ngo_dom = ifelse(prop_ngo_dom == 0, -0.05, prop_ngo_dom)) %>% \n  ggplot(aes(x = year, y = prop_ngo_dom, group = country)) +\n  geom_line(size = 0.1, alpha = 0.5) +\n  geom_hline(yintercept = 0.001) +\n  scale_y_continuous(labels = c(\"Exactly 0%\", \">0%\", \"25%\", \"50%\", \"75%\", \"100%\"), \n                     breaks = c(-0.05, 0.001, 0.25, 0.5, 0.75, 1)) +\n  labs(x = NULL, y = \"Proportion of aid to domestic NGOs\", color = NULL) +\n  theme_donors()\n```\n\n::: {.cell-output-display}\n![](model-tricky-outcomes_files/figure-html/plot-all-prop-ngo-domestic-1.png){fig-align='center' width=100%}\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndf_country_aid_laws %>% \n  mutate(prop_ngo_foreign = ifelse(prop_ngo_foreign == 0, -0.05, prop_ngo_foreign)) %>% \n  ggplot(aes(x = year, y = prop_ngo_foreign, group = country)) +\n  geom_line(size = 0.1, alpha = 0.5) +\n  geom_hline(yintercept = 0.001) +\n  scale_y_continuous(labels = c(\"Exactly 0%\", \">0%\", \"25%\", \"50%\", \"75%\", \"100%\"), \n                     breaks = c(-0.05, 0.001, 0.25, 0.5, 0.75, 1)) +\n  labs(x = NULL, y = \"Proportion of aid to foreign NGOs\", color = NULL) +\n  theme_donors()\n```\n\n::: {.cell-output-display}\n![](model-tricky-outcomes_files/figure-html/plot-all-prop-ngo-foreign-1.png){fig-align='center' width=100%}\n:::\n:::\n\n\n\n# Hurdle models (total aid)\n\nWe're not entirely sure what the actual underlying zero process is for foreign aid, but from looking at the data, we know that there's a time component—before 1995 and after 2005 lots of countries received no aid. We don't know why, though. Maybe there are issues with reporting quality. Maybe some countries didn't need aid anymore (almost like a survival model, but not really, since countries can resume getting aid later after seeing a 0). Maybe there were political reasons. It's impossible to tell, and it goes beyond the scope of our paper here. \n\nWe can see the year-based differences in the presence/absence of 0s in this plot here, with a few countries highlighted to show possible trajectories over time: Georgia starting with 0s then rising to regular levels of aid; Trinidad and Tobago starting with regular levels of aid and then dropping to 0s; Estonia starting with regular levels of aid and then dropping to 0, then resuming aid, then dropping to 0s again.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndf_hurdle_highlight <- df_country_aid_laws %>% \n  mutate(highlight_country = ifelse(country %in% c(\"Estonia\", \"Georgia\", \"Trinidad & Tobago\"), \n                                    country, \"Other\"),\n         highlight_country = factor(highlight_country, ordered = TRUE),\n         highlight_country = fct_relevel(highlight_country, \"Other\", after = Inf)) %>% \n  mutate(highlight = highlight_country != \"Other\")\n\ndf_hurdle_highlight %>% \n  ggplot(aes(x = year, y = total_oda, group = country, \n             color = highlight_country, size = highlight)) +\n  geom_line() +\n  scale_y_continuous(trans = \"log1p\", breaks = c(0, 1e5, 1e8, 1e11),\n                     labels = label_dollar(scale_cut = cut_short_scale())) +\n  scale_color_manual(values = c(clrs$Prism[2], clrs$Prism[7], clrs$Prism[9], \"grey50\")) +\n  scale_size_manual(values = c(0.075, 1.25), guide = \"none\") +\n  labs(x = NULL, y = \"Total ODA (logged)\", color = NULL) +\n  guides(color = guide_legend(override.aes = list(linewidth = 1))) +\n  theme_donors()\n```\n\n::: {.cell-output-display}\n![](model-tricky-outcomes_files/figure-html/plot-oda-over-time-highlight-1.png){fig-align='center' width=100%}\n:::\n:::\n\n\n## Formal statistical model\n\nTo account for these dips into 0, we'll use a hurdle lognormal family (since ODA is exponentially distributed) with a multilevel hierarchical model with country-specific intercepts and a year trend with country-specific offsets (following yet another guide I wrote for this project, [this one on multilevel panel data](https://www.andrewheiss.com/blog/2021/12/01/multilevel-models-panel-data-guide/)). \n\nWe center the year at 2000 so that (1) the intercept is interpretable [@Schielzeth:2010] and (2) the MCMC simulation runs faster and more efficiently [@McElreath:2020 §13.4, pp. 420–422].\n\nIn the actual models we run we include treatment history, independent variables related to civil society, and inverse probability weights, but here since we're just exploring the mechanics of multilevel hurdle models, we use just a country-and-year-only model.\n\nIn **brms**'s [random effects syntax](https://bbolker.github.io/mixedmodels-misc/glmmFAQ.html#model-specification), the model formula looks like this:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"show\"}\nbf(total_oda ~ year_c + (1 + year_c | gwcode),\n   hu ~ year_c)\n```\n:::\n\n\n@eq-hurdle-baseline shows this in more formal mathematical notation, with all the different random effects offsets and priors all working together simultaneously:\n\n::: {.column-page-inset-right}\n\n$$\n\\begin{aligned}\n& \\mathrlap{\\textbf{Hurdled model of aid $i$ across time $t$ within each country $j$}} \\\\\n\\text{Foreign aid}_{it_j} &\\sim \\mathrlap{\\operatorname{Hurdle\\,log-normal}(\\pi_{it}, \\mu_{it_j}, \\sigma_y) \\quad \\text{or alternatively,}} \\\\\n\\text{Foreign aid}_{it_j} &\\sim \\mathrlap{\\begin{cases}\n0 & \\text{with probability } \\pi_{it} \\\\[4pt]\n\\operatorname{Log-normal}(\\mu_{it_j}, \\sigma_y) & \\text{with probability } 1 - \\pi_{it}\n\\end{cases}} \\\\\n\\\\\n& \\textbf{Models for distribution parameters} \\\\\n\\operatorname{logit}(\\pi_{it}) &= \\gamma_0 + \\gamma_1 \\text{Year}_{it} & \\text{Zero/not-zero process} \\\\[4pt]\n\\log (\\mu_{it_j}) &= (\\beta_0 + b_{0_j}) + (\\beta_1 + b_{1_j}) \\text{Year}_{it_j} & \\text{Within-country variation} \\\\[4pt]\n\\left(\n  \\begin{array}{c} \n  b_{0_j} \\\\\n  b_{1_j}\n  \\end{array}\n\\right) \n&\\sim \\text{MV}\\,\\mathcal{N}\n\\left[\n  \\left(\n    \\begin{array}{c}\n    0 \\\\\n    0 \\\\\n    \\end{array}\n  \\right)\n  , \\,\n  \\left(\n  \\begin{array}{cc}\n     \\sigma^2_{0} & \\rho_{0, 1}\\, \\sigma_{0} \\sigma_{1} \\\\ \n     \\cdots & \\sigma^2_{1}\n  \\end{array}\n\\right)\n\\right] & \\text{Variability in average intercepts and slopes} \\\\\n\\\\\n& \\textbf{Priors} \\\\\n\\gamma_0 &\\sim \\text{Student $t$}(3, -2, 1.5) & \\text{Prior for intercept in hurdle model} \\\\\n\\gamma_1 &\\sim \\text{Student $t$}(3, 0, 1.5) & \\text{Prior for year effect in hurdle model} \\\\\n\\beta_0 &\\sim \\mathcal{N}(20, 2.5) & \\text{Prior for global average aid} \\\\\n\\beta_1 &\\sim \\mathcal{N}(0, 2) & \\text{Prior for global year effect} \\\\\n\\sigma_y &\\sim \\operatorname{Exponential}(1) & \\text{Prior for within-country variability} \\\\\n\\sigma_0 &\\sim \\operatorname{Exponential}(1) & \\text{Prior for between-country intercept variability} \\\\\n\\sigma_1 &\\sim \\operatorname{Exponential}(1) & \\text{Prior for between-country slope variability} \\\\\n\\rho &\\sim \\operatorname{LKJ}(2) & \\text{Prior for between-country variability}\n\\end{aligned}\n$$ {#eq-hurdle-baseline}\n\n:::\n\n## Prior simulation\n\nFor this year-and-country-only model, we set the following priors:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndesign <- \"\n  AAABBB\n  CCCDDD\n  EEFFGG\n\"\n\nm_oda_prelim_time_only_total$priors %>% \n  parse_dist() %>% \n  # K = dimension of correlation matrix; \n  # ours is 2x2 here because we have one random slope\n  marginalize_lkjcorr(K = 2) %>%\n  mutate(nice_title = glue::glue(\"**{class}**: {prior}\"),\n         stage = ifelse(dpar == \"hu\", \"Hurdle part (π)\", \"Lognormal part (µ and σ)\")) %>% \n  mutate(nice_title = fct_inorder(nice_title)) %>% \n  ggplot(aes(y = 0, dist = .dist, args = .args, fill = prior)) +\n  stat_slab(normalize = \"panels\") +\n  scale_fill_manual(values = clrs$Prism[1:6]) +\n  facet_manual(vars(stage, nice_title), design = design, scales = \"free_x\",\n               strip = strip_nested(background_x = list(element_rect(fill = \"grey92\"), NULL),\n                                    by_layer_x = TRUE)) +\n  guides(fill = \"none\") +\n  labs(x = NULL, y = NULL) +\n  theme_donors(prior = TRUE) +\n  theme(strip.text = element_markdown())\n```\n\n::: {.cell-output-display}\n![](model-tricky-outcomes_files/figure-html/plot-hurdle-priors-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\nTo make sure these are somewhat reasonable priors, we simulate from them exclusively (following the process outlined in both [*Statistical Rethinking*](https://xcelab.net/rm/statistical-rethinking/) and [*Bayes Rules!*](https://www.bayesrulesbook.com/)). Some of these are wild and go into the trillions, but in general they're in the hundreds-of-millions-of-dollars range, which is good. \n\nThese'll do.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndf_country_aid_laws %>%  \n  add_epred_draws(m_oda_prelim_time_only_total$model_prior_only, ndraws = 9,\n                  seed = 12345) %>% \n  mutate(year = year_c + 2000) %>% \n  ggplot(aes(x = year, y = .epred, group = paste(gwcode, .draw))) +\n  geom_line(linewidth = 0.15, color = clrs$Prism[8]) +\n  scale_y_log10(labels = label_dollar(scale_cut = cut_short_scale())) +\n  coord_cartesian(ylim = c(1e3, 5e11)) +\n  facet_wrap(vars(.draw)) +\n  labs(x = \"Year\", y = \"Foreign aid\", title = \"Results sampled from prior only\",\n       subtitle = \"Each panel shows plausible aid-year relationships for 142 simulated countries\") +\n  theme_donors()\n```\n\n::: {.cell-output-display}\n![](model-tricky-outcomes_files/figure-html/prior-simulations-hurdle-1.png){fig-align='center' width=85%}\n:::\n:::\n\n\n## Posterior checks\n\n\n\n\n\n### MCMC diagnostics\n\n::: {.panel-tabset}\n\n#### Trace plots\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nm_oda_prelim_time_only_total$model %>% \n  gather_draws(`^b_.*|^sd_.*|^cor_.*|^sigma`, regex = TRUE) %>% \n  ggplot(aes(x = .iteration, y = .value, color = factor(.chain))) +\n  geom_line(size = 0.1) +\n  scale_color_manual(values = clrs$Sunset[3:6]) +\n  facet_wrap(vars(.variable), scales = \"free_y\") +\n  theme_donors()\n```\n\n::: {.cell-output-display}\n![](model-tricky-outcomes_files/figure-html/plot-hu-trace-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n#### Trank plots\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nm_oda_prelim_time_only_total$model %>% \n  gather_draws(`^b_.*|^sd_.*|^cor_.*|^sigma`, regex = TRUE) %>% \n  group_by(.variable) %>% \n  mutate(draw_rank = rank(.value)) %>% \n  ggplot(aes(x = draw_rank, color = factor(.chain))) +\n  stat_bin(geom = \"step\", binwidth = 500, position = position_identity(), boundary = 0) +\n  scale_color_manual(values = clrs$Sunset[3:6]) +\n  facet_wrap(vars(.variable), scales = \"free_y\") +\n  theme_donors() +\n  theme(axis.text.y = element_blank(), axis.title.y = element_blank(), axis.ticks.y = element_blank())\n```\n\n::: {.cell-output-display}\n![](model-tricky-outcomes_files/figure-html/plot-hu-trank-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n#### MCMC duration\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"show\"}\nrstan::get_elapsed_time(m_oda_prelim_time_only_total$model$fit)\n##         warmup sample\n## chain:1   24.0   64.0\n## chain:2   24.9   65.8\n## chain:3   25.4   63.6\n## chain:4   25.5   63.3\n\nrstan::get_elapsed_time(m_oda_prelim_time_only_total$model$fit) %>% \n  as.data.frame() %>% \n  summarize(longest = lubridate::as.duration(max(warmup + sample)))\n##                   longest\n## 1 90.676s (~1.51 minutes)\n```\n:::\n\n\n:::\n\n### Posterior predictive check\n\nLook at that—it all fits so nicely!\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\npp_check(m_oda_prelim_time_only_total$model, ndraws = 20) +\n  coord_cartesian(xlim = c(0, 1e10)) +\n  labs(x = \"Total ODA\", title = \"Hurdle lognormal model posterior predictive check\") +\n  scale_x_continuous(labels = label_dollar(scale_cut = cut_short_scale())) +\n  theme_donors() +\n  theme(axis.text.y = element_blank())\n```\n\n::: {.cell-output-display}\n![](model-tricky-outcomes_files/figure-html/plot-pp-check-hu-1.png){fig-align='center' width=100%}\n:::\n:::\n\n\n\n## Analyzing the posterior\n\nIn the actual paper we only interpret the treatment coefficient (total count of barriers, specific barriers, and V-Dem's civil society index), since that's all we can legally interpret when doing causal inference—we've only identified and closed off one pathway in the DAG, so all the other coefficients are incomplete [@WestreichGreenland:2013; @KeeleStevensonElwert:2020].\n\nTo help with the intuition behind all these coefficients and moving parts in this hurdle model, though, it's helpful to walk through the different population-level (or global within-country) effects, group level (between-country) effects, and the within- and between-country variability.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nr_hurdle <- bind_rows(\n  \"original\" = tidy(m_oda_prelim_time_only_total$model),\n  \"exp\" = tidy(m_oda_prelim_time_only_total$model) %>% \n    mutate(across(c(estimate, conf.low, conf.high), ~exp(.))),\n  .id = \"model_type\"\n) |> \n  group_by(model_type) |> \n  mutate(term = janitor::make_clean_names(term)) |> \n  # mutate(nice = round(estimate, 3),\n  #        inv = plogis(estimate),\n  #        inv_nice = round(inv, 3)) |> \n  ungroup() |> \n  split(~ term + model_type)\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"show\"}\ntidy(m_oda_prelim_time_only_total$model) %>% \n  mutate(across(c(estimate, conf.low, conf.high), ~exp(.)))\n## # A tibble: 8 × 8\n##   effect   component group    term                    estimate std.error conf.low conf.high\n##   <chr>    <chr>     <chr>    <chr>                      <dbl>     <dbl>    <dbl>     <dbl>\n## 1 fixed    cond      <NA>     (Intercept)              3.73e+8   0.126    2.93e+8   4.78e+8\n## 2 fixed    cond      <NA>     hu_(Intercept)           4.54e-2   0.0974   3.72e-2   5.46e-2\n## 3 fixed    cond      <NA>     hu_year_c                1.10e+0   0.0119   1.07e+0   1.13e+0\n## 4 fixed    cond      <NA>     year_c                   1.03e+0   0.00787  1.01e+0   1.04e+0\n## 5 ran_pars cond      gwcode   sd__(Intercept)          4.50e+0   0.0931   3.81e+0   5.48e+0\n## 6 ran_pars cond      gwcode   sd__year_c               1.09e+0   0.00639  1.08e+0   1.10e+0\n## 7 ran_pars cond      gwcode   cor__(Intercept).year_c  9.15e-1   0.0943   7.64e-1   1.10e+0\n## 8 ran_pars cond      Residual sd__Observation          2.80e+0   0.0139   2.73e+0   2.88e+0\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# plot_cap(m_oda_prelim_time_only_total$model, condition = \"year_c\", type = \"link\")\n# plot_cap(m_oda_prelim_time_only_total$model, condition = \"year_c\", type = \"response\")\n\nmfx_year_hurdle <- m_oda_prelim_time_only_total$model %>% \n  marginaleffects(newdata = datagrid(year_c = seq(-10, 13, by = 1)),\n                  type = \"response\") %>% \n  posteriordraws()\n\nmfx_year_hurdle %>%\n  mutate(year = year_c + 2000) %>% \n  ggplot(aes(x = year, y = draw)) +\n  stat_pointinterval()\n## Warning: Using the `size` aesthietic with geom_segment was deprecated in ggplot2 3.4.0.\n## ℹ Please use the `linewidth` aesthetic instead.\n```\n\n::: {.cell-output-display}\n![](model-tricky-outcomes_files/figure-html/plot-mfx-hu-1.png){fig-align='center' width=80%}\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nm_oda_prelim_time_only_total$model\n##  Family: hurdle_lognormal \n##   Links: mu = identity; sigma = identity; hu = logit \n## Formula: total_oda ~ year_c + (1 + year_c | gwcode) \n##          hu ~ year_c\n##    Data: dat (Number of observations: 3293) \n##   Draws: 4 chains, each with iter = 5000; warmup = 1000; thin = 1;\n##          total post-warmup draws = 16000\n## \n## Group-Level Effects: \n## ~gwcode (Number of levels: 142) \n##                       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS\n## sd(Intercept)             1.50      0.09     1.34     1.70 1.00     1520     3394\n## sd(year_c)                0.08      0.01     0.07     0.10 1.00     4748     7688\n## cor(Intercept,year_c)    -0.09      0.09    -0.27     0.09 1.00     3168     5565\n## \n## Population-Level Effects: \n##              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS\n## Intercept       19.74      0.13    19.49    19.99 1.01      705     1479\n## hu_Intercept    -3.09      0.10    -3.29    -2.91 1.00    20490    12723\n## hu_year_c        0.10      0.01     0.07     0.12 1.00    22365    12855\n## year_c           0.03      0.01     0.01     0.04 1.00     2889     5826\n## \n## Family Specific Parameters: \n##       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS\n## sigma     1.03      0.01     1.00     1.06 1.00    24290    11677\n## \n## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS\n## and Tail_ESS are effective sample size measures, and Rhat is the potential\n## scale reduction factor on split chains (at convergence, Rhat = 1).\n```\n:::\n\n\n### Global analysis\n\n\n\n### Country-specific analysis\n\n### Within- and between-country variability\n\n\n::: {.cell layout-align=\"center\" hash='model-tricky-outcomes_cache/html/model-prelim-icc_744183cc6cd0a38e4a21e55e1d1f4568'}\n\n```{.r .cell-code}\nperformance::variance_decomposition(m_oda_prelim_time_only_total$model)\n## # Random Effect Variances and ICC\n## \n## Conditioned on: all random effects\n## \n## ## Variance Ratio (comparable to ICC)\n## Ratio: 0.97  CI 95%: [0.93 0.99]\n## \n## ## Variances of Posterior Predicted Distribution\n## Conditioned on fixed effects:   850303738698844800.00  CI 95%: [  470000885202598848.00  1633250823886342656.00]\n## Conditioned on rand. effects: 28304191097921429504.00  CI 95%: [15989794104293294080.00 86611794016574160896.00]\n## \n## ## Difference in Variances\n## Difference: 27414213414894862336.00  CI 95%: [15108915076446498816.00 85629569964719816704.00]\n```\n:::\n\n\n### Everything all at once\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\np1 <- m_oda_prelim_time_only_total$model %>% \n  epred_draws(newdata = tibble(year_c = seq(-10, 13, 1)),\n              re_formula = NA) %>% \n  mutate(year = year_c + 2000) %>% \n  ggplot(aes(x = year, y = .epred)) +\n  stat_lineribbon(color = clrs$Peach[7], alpha = 0.3) +\n  scale_y_continuous(labels = label_dollar(scale_cut = cut_short_scale())) +\n  scale_fill_manual(values = clrs$Peach[3:5]) +\n  guides(fill = \"none\") +\n  labs(x = NULL, y = \"Predicted foriegn aid\",\n       subtitle = \"Predicted global average foreign aid, both µ and hu\") +\n  theme_donors()\n\np2 <- m_oda_prelim_time_only_total$model %>% \n  linpred_draws(newdata = tibble(year_c = seq(-10, 13, 1)),\n                re_formula = NA, dpar = \"mu\") %>% \n  mutate(.linpred = exp(.linpred)) %>% \n  mutate(year = year_c + 2000) %>% \n  ggplot(aes(x = year, y = .linpred)) +\n  stat_lineribbon(color = clrs$PurpOr[7], alpha = 0.3) +\n  scale_y_continuous(labels = label_dollar(scale_cut = cut_short_scale())) +\n  scale_fill_manual(values = clrs$PurpOr[3:5]) +\n  guides(fill = \"none\") +\n  labs(x = NULL, y = \"Predicted foriegn aid\",\n       subtitle = \"Predicted global average foreign aid, µ only\") +\n  theme_donors()\n\np3 <- m_oda_prelim_time_only_total$model %>% \n  linpred_draws(newdata = tibble(year_c = seq(-10, 13, 1)),\n                re_formula = NA,\n                dpar = \"hu\", transform = TRUE) %>% \n  mutate(year = year_c + 2000) %>% \n  ggplot(aes(x = year, y = hu)) +\n  stat_lineribbon(color = clrs$Emrld[7], alpha = 0.3) +\n  scale_y_continuous(labels = label_percent()) +\n  scale_fill_manual(values = clrs$Emrld[2:4]) +\n  guides(fill = \"none\") +\n  labs(x = NULL, y = \"Predicted proportion of\\ncountries receiving no aid\",\n       subtitle = \"Predicted global proportion of countries receiving no aid, hu only\") +\n  theme_donors()\n\n(p1 / p2 / p3) +\n  plot_annotation(title = \"Conditional effect of time on foreign aid\",\n                  subtitle = \"total_aid ~ year + (1 + year | country)\\nhu ~ year\",\n                  theme = theme(plot.title = element_text(family = \"Noto Sans\", face = \"bold\"),\n                                plot.subtitle = element_text(family = \"Inconsolata\")))\n```\n\n::: {.cell-output-display}\n![](model-tricky-outcomes_files/figure-html/plot-baseline-all-parts-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n\n# Zero-inflated models (proportions)\n\n\nProportion of contentious aid\n\nProportion of aid to type of NGO\n\nhttps://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/\n\n## Formal statistical model\n\n::: {.column-page-inset-right}\n\n$$\n\\begin{aligned}\n& \\mathrlap{\\textbf{Zero-inflated model of proportion $i$ across time $t$ within each country $j$}} \\\\\n\\text{Proportion}_{it_j} &\\sim \\operatorname{Zero-inflated\\, Beta}(\\pi_{it}, \\mu_{it_j}, \\phi_y) \\\\\n\\\\\n& \\textbf{Models for distribution parameters} \\\\\n\\operatorname{logit}(\\pi_{it}) &= \\gamma_0 + \\gamma_1 \\text{Year}_{it} & \\text{Zero/not-zero process} \\\\[4pt]\n\\operatorname{logit}(\\mu_{it_j}) &= (\\beta_0 + b_{0_j}) + (\\beta_1 + b_{1_j}) \\text{Year}_{it_j} & \\text{Within-country variation} \\\\[4pt]\n\\left(\n  \\begin{array}{c} \n  b_{0_j} \\\\\n  b_{1_j}\n  \\end{array}\n\\right) \n&\\sim \\text{MV}\\,\\mathcal{N}\n\\left[\n  \\left(\n    \\begin{array}{c}\n    0 \\\\\n    0 \\\\\n    \\end{array}\n  \\right)\n  , \\,\n  \\left(\n  \\begin{array}{cc}\n     \\sigma^2_{0} & \\rho_{0, 1}\\, \\sigma_{0} \\sigma_{1} \\\\ \n     \\cdots & \\sigma^2_{1}\n  \\end{array}\n\\right)\n\\right] & \\text{Variability in average intercepts and slopes} \\\\\n\\\\\n& \\textbf{Priors} \\\\\n\\gamma_0 &\\sim \\text{Student $t$}(3, 0, 1.5) & \\text{Prior for intercept in hurdle model} \\\\\n\\gamma_1 &\\sim \\text{Student $t$}(3, 0, 1.5) & \\text{Prior for year effect in hurdle model} \\\\\n\\beta_0 &\\sim \\text{Student $t$}(3, 0, 1.5) & \\text{Prior for global average proportion} \\\\\n\\beta_1 &\\sim \\text{Student $t$}(3, 0, 1.5) & \\text{Prior for global year effect} \\\\\n\\phi_y &\\sim \\operatorname{Exponential}(1) & \\text{Prior for within-country variability} \\\\\n\\sigma_0 &\\sim \\operatorname{Exponential}(1) & \\text{Prior for between-country intercept variability} \\\\\n\\sigma_1 &\\sim \\operatorname{Exponential}(1) & \\text{Prior for between-country slope variability} \\\\\n\\rho &\\sim \\operatorname{LKJ}(2) & \\text{Prior for between-country variability}\n\\end{aligned}\n$$ {#eq-zibeta-baseline}\n\n:::\n\n## Prior simulation\n\n## Posterior analysis\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\np1 <- m_purpose_prelim_time_only_total$model %>% \n  epred_draws(newdata = tibble(year_c = seq(-10, 13, 1)),\n              re_formula = NA) %>% \n  mutate(year = year_c + 2000) %>% \n  ggplot(aes(x = year, y = .epred)) +\n  stat_lineribbon(color = clrs$Peach[7], alpha = 0.3) +\n  scale_y_continuous(labels = label_percent()) +\n  scale_fill_manual(values = clrs$Peach[3:5]) +\n  coord_cartesian(ylim = c(0, 0.16)) +\n  guides(fill = \"none\") +\n  labs(x = NULL, y = \"Predicted percentage of\\ncontentious aid\",\n       subtitle = \"Predicted global average proportion of contentious aid, both µ and zi\") +\n  theme_donors()\n\np2 <- m_purpose_prelim_time_only_total$model %>% \n  linpred_draws(newdata = tibble(year_c = seq(-10, 13, 1)),\n                re_formula = NA, dpar = \"mu\") %>% \n  mutate(.linpred = plogis(.linpred)) %>% \n  mutate(year = year_c + 2000) %>% \n  ggplot(aes(x = year, y = .linpred)) +\n  stat_lineribbon(color = clrs$PurpOr[7], alpha = 0.3) +\n  scale_y_continuous(labels = label_percent()) +\n  scale_fill_manual(values = clrs$PurpOr[3:5]) +\n  coord_cartesian(ylim = c(0, 0.16)) +\n  guides(fill = \"none\") +\n  labs(x = NULL, y = \"Predicted percentage of\\ncontentious aid\",\n       subtitle = \"Predicted global average proportion of contentious aid, µ only\") +\n  theme_donors()\n\np3 <- m_purpose_prelim_time_only_total$model %>% \n  linpred_draws(newdata = tibble(year_c = seq(-10, 13, 1)),\n                re_formula = NA,\n                dpar = \"zi\", transform = TRUE) %>% \n  mutate(year = year_c + 2000) %>% \n  ggplot(aes(x = year, y = zi)) +\n  stat_lineribbon(color = clrs$Emrld[7], alpha = 0.3) +\n  scale_y_continuous(labels = label_percent()) +\n  scale_fill_manual(values = clrs$Emrld[2:4]) +\n  guides(fill = \"none\") +\n  labs(x = NULL, y = \"Predicted proportion of\\ncountries with 0% contentious aid\",\n       subtitle = \"Predicted global proportion of countries receiving no contentious aid, zi only\") +\n  theme_donors()\n\n(p1 / p2 / p3) +\n  plot_annotation(title = \"Conditional effect of time on proportion of contentious aid\",\n                  subtitle = \"prop_contentious ~ year + (1 + year | country)\\nzi ~ year\",\n                  theme = theme(plot.title = element_text(family = \"Noto Sans\", face = \"bold\"),\n                                plot.subtitle = element_text(family = \"Inconsolata\")))\n```\n\n::: {.cell-output-display}\n![](model-tricky-outcomes_files/figure-html/plot-baseline-zi-all-parts-1.png){fig-align='center' width=100%}\n:::\n:::\n\n\n## MCMC diagnostics\n\n::: {.panel-tabset}\n\n### Trace plots\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nm_purpose_prelim_time_only_total$model %>% \n  gather_draws(`^b_.*|^sd_.*|^cor_.*|^phi`, regex = TRUE) %>% \n  ggplot(aes(x = .iteration, y = .value, color = factor(.chain))) +\n  geom_line(size = 0.1) +\n  scale_color_manual(values = clrs$Sunset[3:6]) +\n  facet_wrap(vars(.variable), scales = \"free_y\") +\n  theme_donors()\n```\n\n::: {.cell-output-display}\n![](model-tricky-outcomes_files/figure-html/plot-zi-trace-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n### Trank plots\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nm_purpose_prelim_time_only_total$model %>% \n  gather_draws(`^b_.*|^sd_.*|^cor_.*|^phi`, regex = TRUE) %>% \n  group_by(.variable) %>% \n  mutate(draw_rank = rank(.value)) %>% \n  ggplot(aes(x = draw_rank, color = factor(.chain))) +\n  stat_bin(geom = \"step\", binwidth = 500, position = position_identity(), boundary = 0) +\n  scale_color_manual(values = clrs$Sunset[3:6]) +\n  facet_wrap(vars(.variable), scales = \"free_y\") +\n  theme_donors() +\n  theme(axis.text.y = element_blank(), axis.title.y = element_blank(), axis.ticks.y = element_blank())\n```\n\n::: {.cell-output-display}\n![](model-tricky-outcomes_files/figure-html/plot-zi-trank-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n### MCMC duration\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"show\"}\nrstan::get_elapsed_time(m_purpose_prelim_time_only_total$model$fit)\n##         warmup sample\n## chain:1   52.8   59.8\n## chain:2   55.2   60.0\n## chain:3   55.8   80.0\n## chain:4   53.1   61.5\n\nrstan::get_elapsed_time(m_purpose_prelim_time_only_total$model$fit) %>% \n  as.data.frame() %>% \n  summarize(longest = lubridate::as.duration(max(warmup + sample)))\n##                    longest\n## 1 135.895s (~2.26 minutes)\n```\n:::\n\n\n:::\n\n\n## Results\n\n## Posterior predictive check\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\npp_check(m_purpose_prelim_time_only_total$model, ndraws = 20) +\n  labs(x = \"Percent of contentious aid\", \n       title = \"Zero-inflated beta model posterior predictive check\") +\n  scale_x_continuous(labels = label_percent()) +\n  theme_donors()\n```\n\n::: {.cell-output-display}\n![](model-tricky-outcomes_files/figure-html/plot-pp-check-zi-1.png){fig-align='center' width=100%}\n:::\n:::\n\n\n\n## Analyzing the posterior\n\n### Global analysis\n\n### Country-specific analysis\n\n### Within- and between-country variability\n\n\n## References\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}